<div class="broker-page">
  <div class="page-header">
    <h1>Broker Connections</h1>
    <button class="btn-primary" (click)="toggleForm()">
      {{ showForm() ? 'Cancel' : '+ Connect Broker' }}
    </button>
  </div>

  <!-- Error Message -->
  @if (errorMessage()) {
    <div class="error-banner">
      {{ errorMessage() }}
    </div>
  }

  <!-- Connection Form -->
  @if (showForm()) {
    <app-card title="Connect to Interactive Brokers" subtitle="Enter your IBKR connection details">
      <form [formGroup]="connectionForm" (ngSubmit)="onSubmit()" class="connection-form">
        <div class="form-grid">
          <div class="form-group">
            <label for="broker">Broker</label>
            <select id="broker" formControlName="broker" class="form-control">
              <option [value]="BrokerType.IBKR">Interactive Brokers (IBKR)</option>
              <!-- Future brokers can be added here -->
            </select>
          </div>

          <div class="form-group">
            <label for="account_code">Account Code</label>
            <input
              type="text"
              id="account_code"
              formControlName="account_code"
              class="form-control"
              placeholder="e.g., DU1234567"
            />
            @if (connectionForm.get('account_code')?.invalid && connectionForm.get('account_code')?.touched) {
              <span class="error-text">Account code is required</span>
            }
          </div>

          <div class="form-group">
            <label for="conn_host">Host</label>
            <input
              type="text"
              id="conn_host"
              formControlName="conn_host"
              class="form-control"
              placeholder="127.0.0.1"
            />
          </div>

          <div class="form-group">
            <label for="conn_port">Port</label>
            <input
              type="number"
              id="conn_port"
              formControlName="conn_port"
              class="form-control"
              placeholder="7497 (Paper) or 7496 (Live)"
            />
            <small class="form-hint">7497 for Paper Trading, 7496 for Live Trading</small>
          </div>

          <div class="form-group">
            <label for="client_id">Client ID</label>
            <input
              type="number"
              id="client_id"
              formControlName="client_id"
              class="form-control"
              placeholder="1"
            />
            <small class="form-hint">Unique ID for this connection (1-9999)</small>
          </div>
        </div>

        <div class="form-actions">
          <button
            type="submit"
            class="btn-primary"
            [disabled]="connectionForm.invalid || isLoading()"
          >
            {{ isLoading() ? 'Connecting...' : 'Connect' }}
          </button>
        </div>
      </form>
    </app-card>
  }

  <!-- Connected Accounts -->
  @if (hasAccounts()) {
    <app-card title="Connected Accounts" subtitle="Manage your broker connections">
      <div class="accounts-list">
        @for (account of accounts(); track account.id) {
          <div class="account-item">
            <div class="account-info">
              <div class="account-header">
                <span class="account-broker">{{ account.broker.toUpperCase() }}</span>
                <span [class]="'status-badge ' + getStatusClass(account.status)">
                  <span class="status-icon">{{ getStatusIcon(account.status) }}</span>
                  {{ account.status }}
                </span>
              </div>
              <div class="account-details">
                <div class="detail-item">
                  <span class="detail-label">Account:</span>
                  <span class="detail-value">{{ account.account_code }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Connection:</span>
                  <span class="detail-value">{{ account.conn_host }}:{{ account.conn_port }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Client ID:</span>
                  <span class="detail-value">{{ account.client_id }}</span>
                </div>
                @if (account.connected_at) {
                  <div class="detail-item">
                    <span class="detail-label">Connected:</span>
                    <span class="detail-value">{{ account.connected_at | date: 'short' }}</span>
                  </div>
                }
              </div>
            </div>
            <div class="account-actions">
              @if (account.status === 'active') {
                <button class="btn-secondary" (click)="syncData(account)">
                  Sync Data
                </button>
              }
              <button class="btn-danger" (click)="disconnect(account)">
                Disconnect
              </button>
            </div>
          </div>
        }
      </div>
    </app-card>
  } @else if (!isLoading() && !showForm()) {
    <app-card>
      <div class="empty-state">
        <div class="empty-icon">ðŸ”Œ</div>
        <h3>No broker connections</h3>
        <p>Connect to Interactive Brokers to sync your portfolio and trades</p>
        <button class="btn-primary" (click)="toggleForm()">
          Connect Broker
        </button>
      </div>
    </app-card>
  }

  <!-- Loading State -->
  @if (isLoading() && !hasAccounts()) {
    <app-card>
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading broker connections...</p>
      </div>
    </app-card>
  }
</div>
